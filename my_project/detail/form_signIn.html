<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/icons-extra.css" rel="stylesheet" type="text/css" />
		<!--self-->
		<link href="../../css/PageSignIn.css" rel="stylesheet" />
		<style>
		    .mui-scroll-wrapper {
                top: 45px;
                bottom: 50px;
                left: 1px;
            }
            .PlaceSvg{
                position: absolute;
                z-index: 10 !important;
            }
            .pane{
                position: relative;
            }
            
		</style>
	</head>
    
	<body>
	    <header class="mui-bar mui-bar-nav">
            <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left " id='back' href="#"></a>
            <a class="mui-icon mui-icon-bars mui-pull-right" href="#ShowList"></a>
            <h1 class="mui-title"><span id="CName"></span></h1>
        </header>
        <div class="mui-content">
            <div class="mui-scroll-wrapper panes wrapper">
                <div class="pinch-zoom" id="ImgPack">
                    <div class="panes" id="ImgPlace">
                        <!--<div class="pane">
                            <img class='paneImg' src='http://112.74.34.150:8080/TongXinweb/images/0b5c5b47-0927-48ec-a336-9b925881ec54/fcc99838-b70d-4e5f-a270-7ef508d4e1f3/(1).png' />
                            <img class="PlaceSvg" style="width:20%;top:100px;left:50px;" src="http://192.168.0.199:8081/zsPC/signUpload/55/1537326518620.svg" />
                        </div>-->
                        <!--<div class="pane">
                            <img class='paneImg' src='http://112.74.34.150:8080/TongXinweb/images/0b5c5b47-0927-48ec-a336-9b925881ec54/fcc99838-b70d-4e5f-a270-7ef508d4e1f3/(1).png' />
                            <img class='PlaceSvg' style='width:25.64102564102564px;height:15.384615384615383px;top:328.2051282051282px;left:191.79487179487177px;' src='http://192.168.0.199:8081/zsPC/signUpload/55/1537326518620.svg' />
                        </div>-->
                    </div>
                </div>
            </div>
            <!--驳回原因输入块-->
            <div id="ShowList" class="mui-popover mui-popover-action mui-popover-bottom">
                <ul class="mui-table-view">
                    <li class="mui-table-view-cell">
                        <a href="#" style="color: #FF3B30;">驳回</a>
                    </li>
                    <li class="mui-table-view-cell">
                        <a href="#" style="color: #FF3B30;">提交</a>
                    </li>
					<!-- <li class="mui-table-view-cell">
					    <a href="#" style="color: green;">定义快捷签名</a>
					</li> -->
					<li class="mui-table-view-cell">
					    <a href="#" style="color:green;">定义快捷签名位置</a>
					</li>
                    <li class="mui-table-view-cell">
                        <a href="#" style="color: ;">撤销签名</a>
                    </li>
                    <li class="mui-table-view-cell">
                        <a href="#" style="color: ;">查看附件</a>
                    </li>
                    <!--<li class="mui-table-view-cell">
                        <a href="#" style="color: ;">授权人签名</a>
                    </li>-->
                </ul>
                <ul class="mui-table-view">
                    <li class="mui-table-view-cell">
                        <a href="#delete"><b>取消</b></a>
                    </li>
                </ul>
            </div>
        </div>
        <footer>
            <!--手写输入切换-->
            <div class="footer-left">
            	<!--<a href="../../excel_form/formtest.html" class="mui-tab-item mui-active" ><img src="../../images/keyboard.png" width="20px" height="20px" style="display: none;"/></a>-->
                <img src="../../images/SignIn.png" width="20px" height="20px" id="SignIn" />
            </div>
			<div style="display: flex;height: 100%;margin-top: 10px;justify-content: space-around">
				<!-- <div class="" style="margin-left: 15%;"> -->
				<span class="mui-icon mui-icon-location" id="quickly"></span>
				<span class="mui-icon mui-icon-map" id="Nail"></span>
				<!-- </div> -->
				<!-- <div class="" style="margin-left: 65%;margin-top: -25px;"> -->
				    <span class="mui-icon mui-icon-mic" id="Recoder"></span>
				<!-- </div> -->
			</div>
            
            <!--查看/发送-->
            <label for="" class="footer-right">
                <img id="msg-check" class="footer-right-page" src="../../images/file.png" style="width: 35px;"  />
                <button type="button" class="mui-btn mui-btn-success footer-right-post" id="postMes" style="display: none;">确认</button>
            </label>
        </footer>
        
        <!--script-->
        <script src="../../js/mui.min.js"></script>
        <script src="../../js/jquery-1.11.0.min.js"></script>
        <script src="../../js/service.js"></script>
        <script src="../../js/signature/hammer.js"></script>
        <script src="../../js/self/SignShow.js"></script>
		<script type="text/javascript">
		    mui('.mui-scroll-wrapper').scroll({
                deceleration: 0.0005, //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
            });
		    /*
		     * get pro Mes
		     */
		    var projectId = localStorage.getItem('projectId');
            var projectName = localStorage.getItem('projectName');
            var TypeName = localStorage.getItem('TypeName');
            var CId = localStorage.getItem('CId');
            var CSdA = localStorage.getItem('CSdA');
            var CirSmp = localStorage.getItem('CirSmp');
			 // console.log(CId)
			 // console.log(CSdA)
			 // console.log(CirSmp)
//          alert(CirSmp)
//          var CId = '55'
//			console.log(localStorage.getItem('SignUrl'))
            canvasWidth = 385
            canvasHeight = 458
            /*
             * 信息加载
             */
            $.ajax({
                type:"post",
                url:url+"action_sign/MesShow_form.php",
                async:true,
                dataType:'json',
                data:{
                    CId:CId
                },
                success:function(data){
					// alert(222)
                 console.log(data)
                    //表单信息处理
                    $('#CName').text(data['data']['TabNam']);
                    localStorage.setItem('page',data['data']['page']);
                    var filePicArr = data['data']['imgurl'].split('(');
                    var imgDataText = urlAPI + filePicArr[0]+'(1)'+'.png';
                    localStorage.setItem('imgUrl',imgDataText);
                    //显示表单
                    var ImgSize = showTab(data['data']['imgurl'],data['data']['page'],data['sign']);
//                  console.log(data['sign'])
                    var ImgSizeArr = ImgSize.split('/',ImgSize);
                    canvasWidth = ImgSizeArr[0]+0;
                    canvasHeight = ImgSizeArr[1]+0;
                    $('.paneImg').attr('width',canvasWidth)
                    $('.paneImg').attr('height',canvasHeight)
                    
                },
                error:function(s,e,t){
//                  alert('出现错误，错误类型：'+e);
                }
            });
            mui.init({
                swipeBack:false,
                statusBarBackground: '#f7f7f7',
            });
			
            mui('body').on('tap', '.mui-popover-action li>a', function() {
                var a = this,parent;
                //根据点击按钮，反推当前是哪个actionsheet
                for (parent = a.parentNode; parent != document.body; parent = parent.parentNode) {
                    if (parent.classList.contains('mui-popover-action')) {
                        break;
                    }
                }
                //关闭actionsheet
                mui('#' + parent.id).popover('toggle');
                //驳回
                if(a.innerHTML == '驳回'){
                    var btnArray = ['取消', '确定'];
                    mui.prompt('请输入审批意见：', '或驳回原因', '建筑文件审批系统', btnArray, function(e) {
                        if (e.index == 1) {
//                          alert('审批意见:' + e.value);
                            $.ajax({
                                type:"post",
                                url:url+"action_sign/MesSave_Reject.php",
                                async:true,
                                dataType:'json',
                                data:{
                                    //FormMes
                                    formId:CId,
                                    //Mes
                                    Mes: e.value,
                                },
                                success:function(data){
//                                  console.log(data)
                                    if(data['ErrorMes']){
                                        alert(data['ErrorMes']+'请及时联系管理员')
                                        return;
                                    }
                                    alert('表单已驳回')
                                    //返回父页面刷新
                                    var target = plus.webview.getWebviewById("project_type_list");
                                    target.reload(true);
                                    mui.back();
                                },
                                error:function(s,e,t){
                                    alert('出现错误，错误类型：'+e);
                                }
                            })
                        }
                    });
                };
                
                //提交
                if(a.innerHTML == '提交'){
					
                    $.ajax({
                        type:"post",
                        url:url+"action_sign/MesSave_Img.php",
//                      async:true,
//                      dataType:'json',
                        data:{
                        	
                            //FormMes
                            formId:CId,
                            //SignMes
                                //位置等信息
                                SignPX : localStorage.getItem('SignPX'),
                                SignPY : localStorage.getItem('SignPY'),
                                FormW : localStorage.getItem('FormX'),
                                FormH : localStorage.getItem('FormY'),
                                SignW : localStorage.getItem('SignWidth'),
                                SignH : localStorage.getItem('SignHeight'),
                                //页数信息
                                PageFinal : localStorage.getItem('PageFinal'),
                                //签名信息
                                SignFinal : localStorage.getItem('SignUrl'),
                                CirSmp :CirSmp
                                //备注
//                              msg:$('#msg-text').val()
                        },
                        success:function(data){
//                      	alert(data)
							 if(data['ErrorMes']){
								 alert(data['ErrorMes']+'请及时联系管理员')
								 return;
							 }
                            alert('提交成功')
							mui.openWindow({
							   url:'../project_type.html',
							})
                            //返回父页面刷新
							 // var target = plus.webview.getWebviewById("project_type_list");
                            // var target=plus.webview.currentWebview().opener();
                            // target.reload(true);
                            // mui.back();
							// var parent = plus.webview.currentWebview().opener();//获取A页面      B页面是从A页面打开
							// mui.fire(parent,'refresh',{isSet:true});
                        },
                        error:function(s,e,t){
                            alert('出现错误，错误类型0：'+e);
                        }
                    })
                }
                //查看附件
                if(a.innerHTML == '查看附件'){
                    mui.openWindow({
                        url:'attachment.html',
                        id:'attachment.html',
                        extras: {
							sjc:CirSmp
                        }
                    })
                } 
                //撤销签名
                if(a.innerHTML == '撤销签名'){
                    $.ajax({
                        type:"post",
                        url:url+"action_sign/MesDel_Svg.php",
						// async:true,
                        dataType:'json', 
                        data:{                         
                            CirSmp :CirSmp,
							// 21.2.27update
							formId:CId 
                        },
                        success:function(data){
                        	alert("撤销成功！")
                        	location.reload()
                        },
                        error:function(s,e,t){
                         // alert('出现错误，错误类型0：'+e);
							alert("无法撤销非本用户签名！")
                        }
                    })
                }
				// //定义快捷签名
				if(a.innerHTML == '定义快捷签名位置'){
					mui.openWindow({
					    url:'SignView_quickly.html',
					    id:'SignView_quickly.html',
					    extras: {
					        fatherPage : 'form_signIn.html'
					    },
					    createNew:true,
					})
				}
				//快捷签名
				// if(a.innerHTML == '快捷签名'){
				// 	mui.openWindow({
				// 		url: 'signPlace2.html',
				// 		id: 'signPlace2.html',
				// 		createNew:true,
				// 	})
				// }
                //授权人签名
//              if(a.innerHTML == '授权人签名'){
//                  mui.openWindow({
//                      url:'SignView_1.html',
//                      id:'SignView_1.html',
//                      extras: {
//							sjc:CirSmp
//                      }
//                  })
//              }
            })
            mui.plusReady(function(){
				

                var val='';
                //打开详情
                $('#msg-check').on('tap',function() {
                    localStorage.setItem('PageStaMes','1');
                    mui.openWindow({
                        url: 'form_mes.html',
                        id: 'form_mes.html',
                        extras: {
                            imgData : val
                        }
                    });
                });
                //打开签名页面
                $('#SignIn').on('tap',function() {
                    mui.openWindow({
                        url:'SignView_1.html',
                        id:'SignView_1.html',
                        extras: {
                            fatherPage : 'form_signIn.html'
                        },
                        createNew:true,
                    })
                })
                //打开语音
                $('#Recoder').on('tap',function() {
                    mui.openWindow({
                        url:'sign_audio.html',
                        id:'sign_audio.html',
                        extras: {
                            
                        }
                    })
                })
                //打开钉钉
                $('#Nail').on('tap',function() {
                    mui.openWindow({
//                  	url:'Tack_mark.html',
//                      id:'Tack_mark.html',ps
                        url:'sign_nail.html',
                        id:'sign_nail.html',
                        extras: {
                            CSdA:CSdA,
                            CirSmp:CirSmp
                        }
                    })
                })
				$('#quickly').on('tap',function() {
					if(localStorage.getItem('SignUrl1')){
						mui.openWindow({
							url: 'signPlace2.html',
							id: 'signPlace2.html',
							createNew:true,
							extras:{
								type:'quickly'
							}
						})
					}else{
						alert('该账号暂未在手机定义快捷签名位置')
					}
					
				})
            });
            //show tab
            function showTab(filePic,page,dataSignDB){
                var filePicArr = filePic.split('(');
                var imgDataText = urlAPI + filePicArr[0]+'(1)'+'.png';
                var img = new Image();
                img.src = imgDataText;
//              console.log(img.src)
				localStorage.setItem('tab_url',imgDataText);
                img.onload = function()
                {
                    //控制背景宽度
                    var imgWidth  = img.width;
                    var imgHeight = img.height;
                    canvasWidth = Math.min(imgWidth , $(window).width()-2);
                    //计算缩放比
                    var scale = canvasWidth/imgWidth;
//                  var canvasHeight = Math.min(imgHeight*scale , $(window).height()-155 );
                    canvasHeight = imgHeight*scale;
                    for (var i=0;i<(page);i++) {
                        var imgText = new Image();
                        imgText.src = urlAPI + filePicArr[0]+'('+(i+1)+')'+'.png';
                        var EleText = "<div class='pane'><img class='paneImg' src='"+imgText.src+"' /></div>";
                        $('#ImgPlace').append(EleText);
                    }
                    //显示签名【前期签批的】
                    
                    //显示签名【本次签批后】
                        //如果存在FormX此属性的值则表示是本次已经签批
                    try{
                        //获取采集数据
                           //位置信息
                        var SignPX = localStorage.getItem('SignPX')
                        var SignPY = localStorage.getItem('SignPY')
                        var FormW = localStorage.getItem('FormX')
                        var FormH = localStorage.getItem('FormY')
                        var SignW = localStorage.getItem('SignWidth')
                        var SignH = localStorage.getItem('SignHeight')
                            //页数信息
                        var PageFinal = localStorage.getItem('PageFinal')
                            //表单id
                        var CIdFinal = localStorage.getItem('CIdFinal')
                            //签名信息
                        var SignFinal =UrlImage +  localStorage.getItem('SignUrl')
//                      console.log(SignFinal)
//                      console.log(CIdFinal)
//                      console.log(CId)
                        //显示签名【本次的，当前流程的】
                        if(CIdFinal == CId)
                        {
                            showSignSvg(SignPX,SignPY,FormW,FormH,SignW,SignH,PageFinal,SignFinal,'ImgPlace')
                        }

                        //显示数据库已存在的签名
                        for (var i=0;i<dataSignDB.length;i++) {
//                      	console.log("执行")                            
                            var SignPX  = dataSignDB[i]['SignPX']
                            var SignPY  = dataSignDB[i]['SignPY']
                            var FormW  = dataSignDB[i]['FormW']
                            var FormH  = dataSignDB[i]['FormH']
                            var SignW  = dataSignDB[i]['SignW']
                            var SignH  = dataSignDB[i]['SignH']
                            var PageFinal  = dataSignDB[i]['PageFinal']
                            var SignFinal  =UrlImage + dataSignDB[i]['SignPa']
//							console.log(SignFinal)
                            showSignSvg(SignPX,SignPY,FormW,FormH,SignW,SignH,PageFinal,SignFinal,'ImgPlace')           
                        }
//                      showSignSvg('166','322','351','496','40','24','1','http://192.168.0.199:8081/zsPC/signUpload/55/1537403106837.svg','ImgPlace')
                    }catch(e){
                        
                    }

                }
                return canvasWidth+'/'+canvasHeight;
            }
            //获取坐标
            function windowToCanvas(x,y){
                var bbox = document.getElementById("ImgPlace").getBoundingClientRect()
                return {x:Math.round(x-bbox.left),y:Math.round(y-bbox.top)}
            }
            /*
             * HAMMER
             */
            //定义实例
//          var el = document.querySelector("#ImgPlace");
//          var transform = {
//              translate: {
//                  x: 0,
//              },
//              scale: 1,
//          };
//          //添加事件
//          var mc = new Hammer.Manager(el);
//          mc.add(new Hammer.Pinch({
//              threshold: 0
//          }));
//          mc.get('pinch').set({ enable: true });
//          mc.add(new Hammer.Pan({
//              threshold: 0,
//              pointers: 0
//          }));
//          var ImgScale = 1;
//          //捏放后
//          mc.on("pinchstart pinchmove", function(ev) {
//              //获取原放大比例
//              var ImgScaleOld = ImgScale
//              
//              if(canvasWidth*ev.scale < canvasWidth){
//                  $('#ImgPack').addClass('pinch-zoom')
//                  ImgScale = 1;
//              }else{
//                  ImgScale = ev.scale;
//                  $('#ImgPack').removeClass('pinch-zoom')
//              }
//              transform.scale = ImgScale;
//              //表单变化
//              $('.paneImg').attr('width',canvasWidth*ImgScale)
//              $('.paneImg').attr('height',canvasHeight*ImgScale)
//              
//              //签名变化
//              var PlaceSvg = document.getElementsByClassName("PlaceSvg")
//              for (var i=0;i<PlaceSvg.length;i++) {
//              	var PlaceSvgW = document.getElementsByClassName('PlaceSvg')[i].width/ImgScaleOld
//                  var PlaceSvgH = document.getElementsByClassName('PlaceSvg')[i].height/ImgScaleOld
//                  var PlaceSvgT = document.getElementsByClassName('PlaceSvg')[i].offsetTop/ImgScaleOld
//                  var PlaceSvgL = document.getElementsByClassName('PlaceSvg')[i].offsetLeft/ImgScaleOld
//                  document.getElementsByClassName('PlaceSvg')[i].style.width = PlaceSvgW*ImgScale +'px'
//                  document.getElementsByClassName('PlaceSvg')[i].style.height = PlaceSvgH*ImgScale +'px'
//                  document.getElementsByClassName('PlaceSvg')[i].style.top = PlaceSvgT*ImgScale +'px'
//                  document.getElementsByClassName('PlaceSvg')[i].style.left = PlaceSvgL*ImgScale +'px'
//              }
//              
//          });
//          //平移后
//          mc.on("panstart panmove", function(ev){
//              if (!(ImgScale ==1)) {
//              	transform.translate = {
//                      x:ev.deltaX,
//                  };
//              } else{
//              	transform.translate = {
//                      x:0
//                  };
//              }
//              el.style.transform = 'translate(' + transform.translate.x + 'px )';
//          });
            function point2D(x,y){
				return {x : x,y : y};
			}
			
			var reqAnimationFrame = (function () {
			    return window[Hammer.prefixed(window, 'requestAnimationFrame')] || function (callback) {
			        window.setTimeout(callback, 1000 / 60);
			    };
			})();
			
			
			var tMatrix = [1,0,0,1,0,0]//x缩放，无，无，y缩放，x平移，y平移
			
			var initScale = 1;//初始化scale
			var el =  document.getElementById("ImgPlace");//获取元素
			var mc = new Hammer.Manager(el)
			var ticking = false
			var poscenter = point2D(0,0);//缓存双指的中心坐标
			var duration = '';//设置过渡效果，用于双击缩放效果
			var lastTranslate = point2D(0,0);//记录上次的偏移值
			var lastcenter= point2D(el.offsetWidth/2,el.offsetHeight/2)//图像的中心点，用于对比双指中心点
			
			var center = lastcenter
			mc.add(new Hammer.Pan({ threshold: 0, pointers: 1 }))
			mc.add(new Hammer.Pinch({ threshold: 0 }))
			mc.add( new Hammer.Tap({ event: 'doubletap', taps: 2 }) );
			mc.on("panmove", onPan);
			mc.on("panstart",onPanStart)
			mc.on("pinchmove", onPinch);
			mc.on("pinchstart",onPinchStart);
			mc.on("doubletap",onDoubleTap);
			
			function onPanStart(ev){
				lastTranslate = point2D(tMatrix[4],tMatrix[5])//缓存上一次的偏移值
			}
			function onPan(ev){	
					duration = ''
					el.className = ''			
					tMatrix[4] = lastTranslate.x + ev.deltaX
					tMatrix[5] = lastTranslate.y + ev.deltaY
					requestElementUpdate('onpan');
				
			}
			function onPinchStart(ev){
				duration = '';
				lastTranslate = point2D(tMatrix[4],tMatrix[5])//记录上一次的偏移值
				initScale = tMatrix[0] || 1;
				poscenter = point2D(ev.center.x, ev.center.y)
				
				lastcenter = point2D(center.x + lastTranslate.x,center.y + lastTranslate.y)//重新计算放大后的中心坐标
				poscenter = point2D(ev.center.x - lastcenter.x, ev.center.y-lastcenter.y)
//				console.log("center",lastcenter.x,lastcenter.y)
				
				requestElementUpdate('onpinchStart');
			}
			function onPinch(ev){
				var nowScale = tMatrix[0] = tMatrix[3] = initScale * ev.scale;
				var composscal = (1 - ev.scale) 
				tMatrix[4] = (1 - ev.scale) * poscenter.x + lastTranslate.x
				tMatrix[5] = (1 - ev.scale) * poscenter.y + lastTranslate.y
				requestElementUpdate('onpinch');	
			}
			
			function onDoubleTap(ev){
				duration = ".3s ease all";
				var nowScale = tMatrix[0];
				if(nowScale != 1 || tMatrix[4]!= 0){
					//scale不等于1，要重回1
					tMatrix[0] = tMatrix[3] = 1;
					tMatrix[4] = tMatrix[5] = 0;
				}else{
					var pointer = ev.center
					var scale = 2
					tMatrix[0] = tMatrix[3] = scale
					tMatrix[4] = (1 - scale) * ( pointer.x - center.x) 
					tMatrix[5] = (1 - scale) * ( pointer.y - center.y)
				}
				requestElementUpdate('doubleTap');
			}
			
			function updateElementTransform() {
				el.style.transition = duration
			    var tmp = tMatrix.join(',')
			//  console.log(tmp)
			    el.style.transform = 'matrix(' + tmp + ')';
			    ticking = false;
			}
			function requestElementUpdate() {
			    if(!ticking) {
			        reqAnimationFrame(updateElementTransform);
			        ticking = true;
			    }
			}
			requestElementUpdate();
        </script>
	</body>
</html>